<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Notificaciones - Certificados</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body data-active-tab="{{ active_tab | default('notificar') }}">
    <div class="main-container">
        <div class="content-card">
            <!-- Header -->
            <h1 class="header-title">
                <i class="bi bi-envelope-check me-2"></i>
                Sistema de Notificación de Certificados
            </h1>

            <!-- Navigation Tabs -->
            <nav class="tab-nav">
                <button class="tab-button" onclick="openTab('notificar')">
                    <i class="bi bi-send me-1"></i> Notificar
                </button>
                <button class="tab-button" onclick="openTab('reporte-general')">
                    <i class="bi bi-file-earmark-text me-1"></i> Reporte General
                </button>
                <button class="tab-button" onclick="openTab('vistas')">
                    <i class="bi bi-pie-chart me-1"></i> Vistas
                </button>
                <button class="tab-button" onclick="openTab('administrar')">
                    <i class="bi bi-gear me-1"></i> Administrar
                </button>
            </nav>

            <!-- Flash Messages -->
            <div class="tab-content">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'success' if category == 'success' else 'warning' if category == 'warning' else 'info' if category == 'info' else 'danger' }} alert-dismissible fade show flash" role="alert">
                                <i class="bi bi-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'warning' else 'info-circle' if category == 'info' else 'x-circle' }} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Tab 1: Notificar -->
                <div id="notificar" class="tab-pane">
                    <h2><i class="bi bi-bell me-2"></i> Enviar Notificaciones</h2>
                    
                    {% if status %}
                    <div class="status-bar">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Envíos en las últimas 24h:</strong> {{ status.count_today }} / {{ status.daily_limit }}
                        <span class="ms-3"><strong>Límite por lote:</strong> {{ config.EMAIL_BATCH_LIMIT }}</span>
                    </div>
                    {% endif %}
                    
                    {% if participants %}
                        <form action="{{ url_for('send_notifications') }}" method="POST">
                            <button type="submit" class="btn btn-success btn-lg mb-3 btn-success-custom">
                                <i class="bi bi-send-fill me-2"></i>
                                Notificar Siguiente Lote ({{ participants|length }})
                            </button>
                        </form>
                        
                        <div class="table-responsive">
                            <table id="tablaNotificar" class="table table-striped table-hover" style="width:100%">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="bi bi-person me-1"></i> Nombre Completo</th>
                                        <th><i class="bi bi-envelope me-1"></i> Correo</th>
                                        <th><i class="bi bi-calendar-event me-1"></i> Evento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p in participants %}
                                    <tr>
                                        <td>{{ p.nombresCompleto }}</td>
                                        <td>{{ p.correo }}</td>
                                        <td>{{ p.nombre_evento }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-success empty" role="alert">
                            <i class="bi bi-check-circle-fill fs-1 d-block mb-3"></i>
                            <strong>¡Excelente!</strong> No hay participantes pendientes de notificar.
                        </div>
                        {% if status and status.remaining_today <= 0 and status.count_today > 0 %}
                            <div class="alert alert-warning limit-msg" role="alert">
                                <i class="bi bi-clock-history me-2"></i>
                                Se ha alcanzado el límite de envíos de 24 horas. Vuelve a intentarlo más tarde.
                            </div>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Tab 2: Reporte General -->
                <div id="reporte-general" class="tab-pane">
                    <h2><i class="bi bi-file-earmark-spreadsheet me-2"></i> Reporte General de Participantes</h2>
                    
                    <div class="report-controls">
                        <form action="{{ url_for('index') }}" method="GET" class="search-form">
                            <input type="hidden" name="tab" value="reporte-general">
                            
                            <div class="form-group">
                                <label for="search_name"><i class="bi bi-search me-1"></i> Buscar por Nombre</label>
                                <input type="text" class="form-control" id="search_name" name="search_name" 
                                       value="{{ search_name }}" placeholder="Nombre del participante..." 
                                       onchange="this.form.submit()">
                            </div>
                            
                            <div class="form-group">
                                <label for="filter_facultad"><i class="bi bi-building me-1"></i> Facultad</label>
                                <select class="form-select" id="filter_facultad" name="filter_facultad" onchange="this.form.submit()">
                                    <option value="">-- Todas --</option>
                                    {% for f in facultades_list %}
                                    <option value="{{ f.idFacultad }}" {% if f.idFacultad|string == current_facultad %}selected{% endif %}>
                                        {{ f.nombreFacultad }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="filter_escuela"><i class="bi bi-mortarboard me-1"></i> Escuela</label>
                                <select class="form-select" id="filter_escuela" name="filter_escuela" onchange="this.form.submit()">
                                    <option value="">-- Todas --</option>
                                    {% for es in escuelas_list %}
                                    <option value="{{ es.idEscuela }}" {% if es.idEscuela|string == current_escuela %}selected{% endif %}>
                                        {{ es.nombreEscuela }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="date_start"><i class="bi bi-calendar-range me-1"></i> Evento (Desde)</label>
                                <input type="date" class="form-control" id="date_start" name="date_start" 
                                       value="{{ current_date_start }}" onchange="this.form.submit()">
                            </div>
                            
                            <div class="form-group">
                                <label for="date_end"><i class="bi bi-calendar-check me-1"></i> Evento (Hasta)</label>
                                <input type="date" class="form-control" id="date_end" name="date_end" 
                                       value="{{ current_date_end }}" onchange="this.form.submit()">
                            </div>
                            
                            <div class="form-group">
                                <label for="noti_date_start"><i class="bi bi-bell me-1"></i> Notif. (Desde)</label>
                                <input type="date" class="form-control" id="noti_date_start" name="noti_date_start" 
                                       value="{{ current_noti_date_start }}" onchange="this.form.submit()">
                            </div>
                            
                            <div class="form-group">
                                <label for="noti_date_end"><i class="bi bi-bell-fill me-1"></i> Notif. (Hasta)</label>
                                <input type="date" class="form-control" id="noti_date_end" name="noti_date_end" 
                                       value="{{ current_noti_date_end }}" onchange="this.form.submit()">
                            </div>
                        </form>
                        
                        <a href="{{ url_for('export_reporte_general', search_name=search_name, filter_facultad=current_facultad, filter_escuela=current_escuela, date_start=current_date_start, date_end=current_date_end, noti_date_start=current_noti_date_start, noti_date_end=current_noti_date_end) }}" 
                           class="btn btn-secondary export-button">
                            <i class="bi bi-file-earmark-excel me-2"></i>
                            Exportar a Excel
                        </a>
                    </div>

                    {% if report_data %}
                        <div class="table-responsive">
                            <table id="tablaReporteGeneral" class="table table-striped table-hover" style="width:100%">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="bi bi-person me-1"></i> Nombre</th>
                                        <th><i class="bi bi-envelope me-1"></i> Correo</th>
                                        <th><i class="bi bi-check-circle me-1"></i> Estado</th>
                                        <th><i class="bi bi-calendar-event me-1"></i> Evento</th>
                                        <th><i class="bi bi-calendar me-1"></i> Fecha Evento</th>
                                        <th><i class="bi bi-building me-1"></i> Facultad</th>
                                        <th><i class="bi bi-mortarboard me-1"></i> Escuela</th>
                                        <th><i class="bi bi-clock-history me-1"></i> Fecha Notificación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in report_data %}
                                    <tr>
                                        <td>{{ r.nombresCompleto }}</td>
                                        <td>{{ r.correo }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if r.estadoNotificado == 'notificado' else 'warning' }}">
                                                {{ r.estadoNotificado | capitalize }}
                                            </span>
                                        </td>
                                        <td>{{ r.nombre_evento }}</td>
                                        <td>{{ r.fecha_evento.strftime('%Y-%m-%d') if r.fecha_evento else 'N/A' }}</td>
                                        <td>{{ r.nombre_facultad or 'N/A' }}</td>
                                        <td>{{ r.nombre_escuela or 'N/A' }}</td>
                                        <td>
                                            {% if r.fecha_notificacion %}
                                                {{ r.fecha_notificacion.strftime('%Y-%m-%d %H:%M:%S') }}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info empty" role="alert">
                            <i class="bi bi-search fs-1 d-block mb-3"></i>
                            No se encontraron participantes con esos filtros.
                        </div>
                    {% endif %}
                </div>

                <!-- Tab 3: Vistas -->
                <div id="vistas" class="tab-pane">
                    <h2><i class="bi bi-graph-up me-2"></i> Vistas de Resumen</h2>

                    <!-- Vista de Eventos -->
                    <div class="view-header">
                        <h3><i class="bi bi-calendar3 me-2"></i> Resumen de Eventos</h3>
                        <a href="{{ url_for('export_excel_eventos') }}" class="btn btn-secondary export-button">
                            <i class="bi bi-file-earmark-excel me-2"></i>
                            Exportar Eventos
                        </a>
                    </div>
                    
                    {% if event_summary %}
                    <div class="table-responsive">
                        <table id="tablaEventos" class="table table-striped table-hover" style="width:100%">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="bi bi-calendar-event me-1"></i> Nombre del Evento</th>
                                    <th><i class="bi bi-calendar me-1"></i> Fecha</th>
                                    <th><i class="bi bi-people me-1"></i> Nro. de Participantes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for evento in event_summary %}
                                <tr>
                                    <td><strong>{{ evento.nombre_evento }}</strong></td>
                                    <td>{{ evento.fecha.strftime('%Y-%m-%d') if evento.fecha else 'N/A' }}</td>
                                    <td>
                                        <span class="badge bg-primary rounded-pill">
                                            {{ evento.numero_participantes }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info empty" role="alert">
                        <i class="bi bi-calendar-x fs-1 d-block mb-3"></i>
                        No hay eventos para mostrar.
                    </div>
                    {% endif %}
                    
                    <hr>

                    <!-- Vista de Participantes -->
                    <div class="view-header">
                        <h3><i class="bi bi-people-fill me-2"></i> Listado Total de Participantes</h3>
                        <a href="{{ url_for('export_excel_participantes') }}" class="btn btn-secondary export-button">
                            <i class="bi bi-file-earmark-excel me-2"></i>
                            Exportar Participantes
                        </a>
                    </div>
                    
                    {% if all_participants %}
                    <div class="table-responsive">
                        <table id="tablaParticipantes" class="table table-striped table-hover" style="width:100%">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="bi bi-person me-1"></i> Nombres Completos</th>
                                    <th><i class="bi bi-envelope me-1"></i> Correo Electrónico</th>
                                    <th><i class="bi bi-calendar-event me-1"></i> Evento</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in all_participants %}
                                <tr>
                                    <td>{{ p.nombresCompleto }}</td>
                                    <td>{{ p.correo }}</td>
                                    <td>{{ p.nombre_evento }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info empty" role="alert">
                        <i class="bi bi-person-x fs-1 d-block mb-3"></i>
                        No hay participantes para mostrar.
                    </div>
                    {% endif %}
                </div>

                <!-- Tab 4: Administrar -->
                <div id="administrar" class="tab-pane">
                    <h2><i class="bi bi-tools me-2"></i> Administrar Datos</h2>
                    
                    <div class="form-grid">
                        <!-- Formulario Agregar Evento -->
                        <div class="form-column">
                            <h3><i class="bi bi-calendar-plus me-2"></i> Agregar Nuevo Evento</h3>
                            <form action="{{ url_for('add_event') }}" method="POST">
                                <div class="form-group">
                                    <label for="nombre_evento">
                                        <i class="bi bi-pencil me-1"></i> Nombre del Evento
                                    </label>
                                    <input type="text" class="form-control" id="nombre_evento" 
                                           name="nombre_evento" placeholder="Ej: Conferencia 2024" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="fecha_evento">
                                        <i class="bi bi-calendar me-1"></i> Fecha del Evento
                                    </label>
                                    <input type="date" class="form-control" id="fecha_evento" 
                                           name="fecha_evento" required>
                                </div>
                                
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary w-100 btn-primary-custom">
                                        <i class="bi bi-save me-2"></i> Guardar Evento
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Formulario Agregar Participante -->
                        <div class="form-column">
                            <h3><i class="bi bi-person-plus me-2"></i> Agregar Nuevo Participante</h3>
                            <form action="{{ url_for('add_participant') }}" method="POST">
                                <div class="form-group">
                                    <label for="nombres_participante">
                                        <i class="bi bi-person me-1"></i> Nombres Completos
                                    </label>
                                    <input type="text" class="form-control" id="nombres_participante" 
                                           name="nombres_participante" placeholder="Ej: Juan Pérez García" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="correo_participante">
                                        <i class="bi bi-envelope me-1"></i> Correo Electrónico
                                    </label>
                                    <input type="email" class="form-control" id="correo_participante" 
                                           name="correo_participante" placeholder="ejemplo@correo.com" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="evento_id">
                                        <i class="bi bi-calendar-event me-1"></i> Asignar a Evento (Requerido)
                                    </label>
                                    <select class="form-select" id="evento_id" name="evento_id" required>
                                        <option value="" disabled selected>-- Selecciona un evento --</option>
                                        {% for evento in events_list %}
                                        <option value="{{ evento.idEvento }}">{{ evento.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="facultad_id">
                                        <i class="bi bi-building me-1"></i> Asignar a Facultad (Opcional)
                                    </label>
                                    <select class="form-select" id="facultad_id" name="facultad_id" 
                                            onchange="updateEscuelas(this.value, 'escuela_id')">
                                        <option value="">-- Ninguna --</option>
                                        {% for f in facultades_list %}
                                        <option value="{{ f.idFacultad }}">{{ f.nombreFacultad }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="escuela_id">
                                        <i class="bi bi-mortarboard me-1"></i> Asignar a Escuela (Opcional)
                                    </label>
                                    <select class="form-select" id="escuela_id" name="escuela_id" disabled>
                                        <option value="">-- Ninguna --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary w-100 btn-primary-custom">
                                        <i class="bi bi-save me-2"></i> Guardar Participante
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Formulario Importar Excel -->
                    <div class="card-custom">
                        <h3><i class="bi bi-file-earmark-excel me-2"></i> Importar Participantes desde Excel</h3>
                        <form action="{{ url_for('upload_excel') }}" method="POST" 
                              enctype="multipart/form-data" style="max-width: 700px;">
                            <div class="form-group">
                                <label for="evento_id_excel">
                                    <i class="bi bi-1-circle me-1"></i> Evento de destino (Requerido)
                                </label>
                                <select class="form-select" id="evento_id_excel" name="evento_id" required>
                                    <option value="" disabled selected>-- Selecciona un evento --</option>
                                    {% for evento in events_list %}
                                    <option value="{{ evento.idEvento }}">{{ evento.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="excel_file">
                                    <i class="bi bi-2-circle me-1"></i> Selecciona el archivo Excel (.xlsx)
                                </label>
                                <input type="file" class="form-control" id="excel_file" 
                                       name="excel_file" accept=".xlsx" required>
                                <small class="form-text text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    El Excel debe tener las columnas: <strong>NombresCompletos</strong>, 
                                    <strong>CorreoElectronico</strong>, <strong>Escuela</strong> y <strong>Facultad</strong>
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" class="btn btn-success w-100 btn-success-custom">
                                    <i class="bi bi-upload me-2"></i> Importar Participantes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- Datos de escuelas para JavaScript -->
    <script>
        window.escuelasData = {{ escuelas_list | tojson }};
    </script>
    
    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
</body>